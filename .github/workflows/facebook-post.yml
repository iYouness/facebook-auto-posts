name: Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†Ø´ÙˆØ±Ø§Øª Facebook Ø§Ù„ÙŠÙˆÙ…ÙŠØ©

on:
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
    inputs:
      action:
        description: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (publish/update)'
        required: true
        default: 'publish'
        type: choice
        options:
          - publish
          - update
  
  # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙˆÙ…ÙŠØ§Ù‹
  schedule:
    # ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 8 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª UTC (9 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…ØºØ±Ø¨ ÙÙŠ Ø§Ù„Ø´ØªØ§Ø¡)
    - cron: '0 20 * * *'

jobs:
  manage_post:
    runs-on: ubuntu-latest
    
    steps:
    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
    
    - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†Ø´ÙˆØ± Ø§Ù„ÙŠÙˆÙ…
      id: check_today_post
      run: |
        TODAY=$(date +%Y-%m-%d)
        echo "today=$TODAY" >> $GITHUB_OUTPUT
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        mkdir -p data
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
        if [ ! -f "data/posts_log.json" ]; then
          echo '{"posts": []}' > data/posts_log.json
          echo "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„"
        fi
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø´ÙˆØ± Ø§Ù„ÙŠÙˆÙ…
        TODAY_POST=$(jq -r --arg today "$TODAY" '.posts[] | select(.date == $today) | .post_id' data/posts_log.json)
        
        if [ -z "$TODAY_POST" ] || [ "$TODAY_POST" == "null" ]; then
          echo "action=publish" >> $GITHUB_OUTPUT
          echo "post_exists=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ± Ù„Ù„ÙŠÙˆÙ… - Ø³ÙŠØªÙ… Ø§Ù„Ù†Ø´Ø±"
        else
          echo "action=update" >> $GITHUB_OUTPUT
          echo "post_exists=true" >> $GITHUB_OUTPUT
          echo "existing_post_id=$TODAY_POST" >> $GITHUB_OUTPUT
          echo "ğŸ”„ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ± Ù„Ù„ÙŠÙˆÙ… ($TODAY_POST) - Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"
        fi
    
    - name: Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø´ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
      id: select_post
      run: |
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ù…Ù†Ø´ÙˆØ±Ø§Øª
        if [ ! -d "posts" ] || [ -z "$(ls -A posts/*.txt 2>/dev/null)" ]; then
          echo "âŒ Ø®Ø·Ø£: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ posts/"
          exit 1
        fi
        
        # Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        POST_FILE=$(ls posts/*.txt | shuf -n 1 | xargs basename)
        echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT
        echo "ğŸ“„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±: $POST_FILE"
    
    - name: Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
      id: read_content
      run: |
        POST_PATH="posts/${{ steps.select_post.outputs.post_file }}"
        
        if [ ! -f "$POST_PATH" ]; then
          echo "âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: $POST_PATH"
          exit 1
        fi
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        CONTENT=$(cat "$POST_PATH")
        
        # Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù Ù…Ø¤Ù‚Øª
        echo "$CONTENT" > /tmp/post_content.txt
        
        echo "âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­"
        echo "Ø§Ù„Ù…Ø­ØªÙˆÙ‰:"
        echo "---"
        cat /tmp/post_content.txt
        echo "---"
    
    - name: Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯
      if: steps.check_today_post.outputs.action == 'publish'
      id: publish_post
      env:
        FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
      run: |
        echo "ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Facebook..."
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù€ URL encoding
        MESSAGE=$(cat /tmp/post_content.txt | jq -sRr @uri)
        
        # Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Facebook
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "https://graph.facebook.com/v21.0/$FB_PAGE_ID/feed" \
          -d "message=$MESSAGE" \
          -d "access_token=$FB_PAGE_TOKEN")
        
        # ÙØµÙ„ Ø§Ù„Ù€ response Ø¹Ù† status code
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "HTTP Status: $HTTP_CODE"
        echo "Response: $BODY"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
        if [ "$HTTP_CODE" -eq 200 ]; then
          POST_ID=$(echo "$BODY" | jq -r '.id')
          
          if [ -z "$POST_ID" ] || [ "$POST_ID" == "null" ]; then
            echo "âŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Post ID"
            echo "$BODY" | jq '.'
            exit 1
          fi
          
          echo "post_id=$POST_ID" >> $GITHUB_OUTPUT
          echo "âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ†” Post ID: $POST_ID"
        else
          echo "âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±!"
          echo "$BODY" | jq '.'
          exit 1
        fi
    
    - name: ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
      if: steps.check_today_post.outputs.action == 'update'
      env:
        FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
      run: |
        POST_ID="${{ steps.check_today_post.outputs.existing_post_id }}"
        echo "ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±: $POST_ID"
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù€ URL encoding
        MESSAGE=$(cat /tmp/post_content.txt | jq -sRr @uri)
        
        # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "https://graph.facebook.com/v21.0/$POST_ID" \
          -d "message=$MESSAGE" \
          -d "access_token=$FB_PAGE_TOKEN")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "HTTP Status: $HTTP_CODE"
        echo "Response: $BODY"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­
        if echo "$BODY" | jq -e '.success == true' > /dev/null 2>&1; then
          echo "âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!"
        else
          echo "âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!"
          echo "$BODY" | jq '.'
          exit 1
        fi
    
    - name: ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
      if: steps.check_today_post.outputs.action == 'publish'
      run: |
        TODAY="${{ steps.check_today_post.outputs.today }}"
        POST_ID="${{ steps.publish_post.outputs.post_id }}"
        POST_FILE="${{ steps.select_post.outputs.post_file }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        jq --arg date "$TODAY" \
           --arg post_id "$POST_ID" \
           --arg file "$POST_FILE" \
           --arg time "$TIMESTAMP" \
           '.posts += [{
             "date": $date,
             "post_id": $post_id,
             "file": $file,
             "published_at": $time,
             "action": "published"
           }]' data/posts_log.json > data/posts_log.tmp
        
        mv data/posts_log.tmp data/posts_log.json
        
        echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„"
    
    - name: ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
      if: steps.check_today_post.outputs.action == 'update'
      run: |
        TODAY="${{ steps.check_today_post.outputs.today }}"
        POST_FILE="${{ steps.select_post.outputs.post_file }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        jq --arg date "$TODAY" \
           --arg file "$POST_FILE" \
           --arg time "$TIMESTAMP" \
           '(.posts[] | select(.date == $date)) += {
             "file": $file,
             "updated_at": $time,
             "action": "updated"
           }' data/posts_log.json > data/posts_log.tmp
        
        mv data/posts_log.tmp data/posts_log.json
        
        echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"
    
    - name: Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Git
      run: |
        git add data/posts_log.json
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        else
          TODAY="${{ steps.check_today_post.outputs.today }}"
          ACTION="${{ steps.check_today_post.outputs.action }}"
          
          if [ "$ACTION" == "publish" ]; then
            COMMIT_MSG="âœ¨ Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯ - $TODAY"
          else
            COMMIT_MSG="ğŸ”„ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø´ÙˆØ± - $TODAY"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Git"
        fi
    
    - name: Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${{ steps.check_today_post.outputs.today }}"
        echo "ğŸ¬ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${{ steps.check_today_post.outputs.action }}"
        echo "ğŸ“„ Ø§Ù„Ù…Ù„Ù: ${{ steps.select_post.outputs.post_file }}"
        
        if [ "${{ steps.check_today_post.outputs.action }}" == "publish" ]; then
          echo "ğŸ†” Post ID: ${{ steps.publish_post.outputs.post_id }}"
        else
          echo "ğŸ†” Post ID: ${{ steps.check_today_post.outputs.existing_post_id }}"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ø³Ø¬Ù„Ø§Øª
        echo ""
        echo "ğŸ“‹ Ø¢Ø®Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª:"
        jq -r '.posts[-5:] | reverse | .[] | "  â€¢ \(.date) - \(.action) - \(.file)"' data/posts_log.json || echo "  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª"
