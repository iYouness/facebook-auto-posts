name: ุฅุฏุงุฑุฉ ููุดูุฑุงุช Facebook ุงูุฐููุฉ

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'ุงูุฅุฌุฑุงุก ุงููุทููุจ'
        required: true
        type: choice
        options:
          - publish
          - update
        default: 'update'
      
      post_file:
        description: 'ุงุณู ุงูููู (ุงุชุฑูู ูุงุฑุบุงู ููุงุฎุชูุงุฑ ุงูุนุดูุงุฆู)'
        required: false
        default: ''
  
  schedule:
    # ููููู ุชุนุฏูู ูุฐู ุงูุฃููุงุช ุญุณุจ ุฑุบุจุชู
    # ุงูุตุจุงุญ: 8 ุตุจุงุญุงู UTC
    - cron: '40 17 * * *'
    # ุงูุธูุฑ: 1 ุธูุฑุงู UTC
    - cron: '45 17 * * *'
    # ุงููุณุงุก: 6 ูุณุงุกู UTC
    - cron: '50 17 * * *'
permissions:
  contents: write  # ุตูุงุญูุฉ ุงููุชุงุจุฉ ุนูู ุงููููุงุช

jobs:
  manage_post:
    runs-on: ubuntu-latest
    
    steps:
    - name: ุชุญููู ุงููููุงุช
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ุฅุนุฏุงุฏ Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
    
    - name: ุชุญุฏูุฏ ุงูุฅุฌุฑุงุก ุงููุทููุจ
      id: determine_action
      run: |
        TODAY=$(date +%Y-%m-%d)
        CURRENT_TIME=$(date +%H:%M)
        
        echo "today=$TODAY" >> $GITHUB_OUTPUT
        echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
        
        # ุฅูุดุงุก ูุฌูุฏ ุงูุจูุงูุงุช
        mkdir -p data
        
        if [ ! -f "data/posts_log.json" ]; then
          echo '{
            "posts": [],
            "schedule": {
              "times": ["08:00", "13:00", "18:00"],
              "timezone": "UTC"
            }
          }' > data/posts_log.json
        fi
        
        # ุชุญุฏูุฏ ุงูุฅุฌุฑุงุก
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          ACTION="${{ github.event.inputs.action }}"
          echo "๐ฑ๏ธ ุชุดุบูู ูุฏูู - ุงูุฅุฌุฑุงุก: $ACTION"
        else
          # ุงูุชุญูู ูู ูุฌูุฏ ููุดูุฑ ุงูููู
          TODAY_POST=$(jq -r --arg today "$TODAY" \
            '.posts[] | select(.date == $today) | .post_id' \
            data/posts_log.json)
          
          if [ -z "$TODAY_POST" ] || [ "$TODAY_POST" == "null" ]; then
            ACTION="publish"
            echo "๐ ุฃูู ุชุดุบูู ุงูููู - ุณูุชู ุงููุดุฑ"
          else
            ACTION="update"
            echo "๐ ููุดูุฑ ููุฌูุฏ - ุณูุชู ุงูุชุนุฏูู"
          fi
        fi
        
        echo "action=$ACTION" >> $GITHUB_OUTPUT
        
        # ุงูุจุญุซ ุนู Post ID ุฅุฐุง ูุงู ููุฌูุฏุงู
        POST_ID=$(jq -r --arg today "$TODAY" \
          '.posts[] | select(.date == $today) | .post_id' \
          data/posts_log.json)
        
        if [ -n "$POST_ID" ] && [ "$POST_ID" != "null" ]; then
          echo "existing_post_id=$POST_ID" >> $GITHUB_OUTPUT
          echo "๐ Post ID ุงูููุฌูุฏ: $POST_ID"
        fi
    
    - name: ุงุฎุชูุงุฑ ููู ุงูููุดูุฑ
      id: select_post
      run: |
        # ุงูุชุญูู ูู ูุฌูุฏ ูููุงุช
        if [ ! -d "posts" ]; then
          echo "โ ุฎุทุฃ: ูุฌูุฏ posts ุบูุฑ ููุฌูุฏ"
          exit 1
        fi
        
        # ุฅุฐุง ุชู ุชุญุฏูุฏ ููู ูุฏููุงู
        if [ -n "${{ github.event.inputs.post_file }}" ]; then
          POST_FILE="posts/${{ github.event.inputs.post_file }}"
          
          if [ ! -f "$POST_FILE" ]; then
            echo "โ ุฎุทุฃ: ุงูููู ุบูุฑ ููุฌูุฏ: $POST_FILE"
            exit 1
          fi
          
          echo "manual_selection=true" >> $GITHUB_OUTPUT
        else
          # ุงุฎุชูุงุฑ ุนุดูุงุฆู ูู ูููุงุช txt
          TEXT_FILES=$(find posts -name "*.txt" -type f)
          
          if [ -z "$TEXT_FILES" ]; then
            echo "โ ุฎุทุฃ: ูุง ุชูุฌุฏ ูููุงุช txt ูู ูุฌูุฏ posts"
            exit 1
          fi
          
          POST_FILE=$(echo "$TEXT_FILES" | shuf -n 1)
          echo "manual_selection=false" >> $GITHUB_OUTPUT
        fi
        
        POST_BASENAME=$(basename "$POST_FILE")
        POST_DIR=$(dirname "$POST_FILE")
        
        echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT
        echo "post_basename=$POST_BASENAME" >> $GITHUB_OUTPUT
        echo "post_dir=$POST_DIR" >> $GITHUB_OUTPUT
        
        echo "โ ุชู ุงุฎุชูุงุฑ: $POST_BASENAME"
    
    - name: ุงูุจุญุซ ุนู ุตูุฑุฉ ูุฑููุฉ
      id: find_image
      run: |
        POST_FILE="${{ steps.select_post.outputs.post_file }}"
        POST_DIR="${{ steps.select_post.outputs.post_dir }}"
        POST_NAME="${{ steps.select_post.outputs.post_basename }}"
        
        # ุฅุฒุงูุฉ ุงูุงูุชุฏุงุฏ
        BASE_NAME="${POST_NAME%.txt}"
        
        # ุงูุจุญุซ ุนู ุตูุฑุฉ ุจููุณ ุงูุงุณู
        IMAGE_FILE=""
        
        for ext in jpg jpeg png gif; do
          if [ -f "$POST_DIR/$BASE_NAME.$ext" ]; then
            IMAGE_FILE="$POST_DIR/$BASE_NAME.$ext"
            break
          fi
        done
        
        # ุฅุฐุง ูู ุชูุฌุฏ ุตูุฑุฉ ุจููุณ ุงูุงุณูุ ุงุจุญุซ ุนู ุฃู ุตูุฑุฉ ูู ููุณ ุงููุฌูุฏ
        if [ -z "$IMAGE_FILE" ]; then
          IMAGE_FILE=$(find "$POST_DIR" -maxdepth 1 \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" \) -type f | head -n 1)
        fi
        
        if [ -n "$IMAGE_FILE" ]; then
          echo "has_image=true" >> $GITHUB_OUTPUT
          echo "image_file=$IMAGE_FILE" >> $GITHUB_OUTPUT
          echo "๐ธ ุตูุฑุฉ ูุฑููุฉ: $(basename $IMAGE_FILE)"
        else
          echo "has_image=false" >> $GITHUB_OUTPUT
          echo "๐ ููุดูุฑ ูุตู ููุท (ุจุฏูู ุตูุฑุฉ)"
        fi
    
    - name: ูุฑุงุกุฉ ูุญุชูู ุงูููุดูุฑ
      id: read_content
      run: |
        POST_FILE="${{ steps.select_post.outputs.post_file }}"
        CURRENT_TIME="${{ steps.determine_action.outputs.current_time }}"
        
        if [ ! -f "$POST_FILE" ]; then
          echo "โ ุฎุทุฃ: ุงูููู ุบูุฑ ููุฌูุฏ"
          exit 1
        fi
        
        CONTENT=$(cat "$POST_FILE")
        
        # ุฅุถุงูุฉ timestamp (ุงุฎุชูุงุฑู - ููููู ุญุฐู ูุฐุง ุงูุฌุฒุก)
        # FOOTER="\n\nโฐ ุชู ุงูุชุญุฏูุซ: $CURRENT_TIME UTC"
        # FULL_CONTENT="${CONTENT}${FOOTER}"
        
        # ุญูุธ ุจุฏูู footer ุฅุฐุง ุฃุฑุฏุช
        FULL_CONTENT="$CONTENT"
        
        echo "$FULL_CONTENT" > /tmp/post_content.txt
        
        echo "โ ุชู ูุฑุงุกุฉ ุงููุญุชูู"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโ"
        cat /tmp/post_content.txt
        echo "โโโโโโโโโโโโโโโโโโโโโโโโ"
    
    - name: ูุดุฑ ููุดูุฑ ุฌุฏูุฏ
      if: steps.determine_action.outputs.action == 'publish'
      id: publish_post
      env:
        FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
      run: |
        echo "๐ค ุฌุงุฑู ุงููุดุฑ..."
        
        MESSAGE=$(cat /tmp/post_content.txt | jq -sRr @uri)
        HAS_IMAGE="${{ steps.find_image.outputs.has_image }}"
        
        if [ "$HAS_IMAGE" == "true" ]; then
          IMAGE_FILE="${{ steps.find_image.outputs.image_file }}"
          echo "๐ธ ูุดุฑ ูุน ุตูุฑุฉ: $(basename $IMAGE_FILE)"
          
          # ุฑูุน ุงูุตูุฑุฉ ุฃููุงู
          PHOTO_RESPONSE=$(curl -s -F "source=@$IMAGE_FILE" \
            -F "access_token=${{ secrets.FB_PAGE_TOKEN }}" \
            "https://graph.facebook.com/v21.0/${{ secrets.FB_PAGE_ID }}/photos" \
            -F "published=false")
          
          PHOTO_ID=$(echo "$PHOTO_RESPONSE" | jq -r '.id')
          
          if [ -z "$PHOTO_ID" ] || [ "$PHOTO_ID" == "null" ]; then
            echo "โ๏ธ ูุดู ุฑูุน ุงูุตูุฑุฉุ ุณูุชู ุงููุดุฑ ุจุฏูู ุตูุฑุฉ"
            echo "$PHOTO_RESPONSE" | jq '.'
            HAS_IMAGE="false"
          else
            echo "โ ุชู ุฑูุน ุงูุตูุฑุฉ: $PHOTO_ID"
          fi
        fi
        
        # ุงููุดุฑ
        if [ "$HAS_IMAGE" == "true" ]; then
          # ูุดุฑ ูุน ุตูุฑุฉ
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://graph.facebook.com/v21.0/$FB_PAGE_ID/feed" \
            -d "message=$MESSAGE" \
            -d "attached_media[0]={\"media_fbid\":\"$PHOTO_ID\"}" \
            -d "access_token=$FB_PAGE_TOKEN")
        else
          # ูุดุฑ ูุตู ููุท
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://graph.facebook.com/v21.0/$FB_PAGE_ID/feed" \
            -d "message=$MESSAGE" \
            -d "access_token=$FB_PAGE_TOKEN")
        fi
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "HTTP Status: $HTTP_CODE"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          POST_ID=$(echo "$BODY" | jq -r '.id')
          
          if [ -z "$POST_ID" ] || [ "$POST_ID" == "null" ]; then
            echo "โ ูุดู ุงุณุชุฎุฑุงุฌ Post ID"
            echo "$BODY" | jq '.'
            exit 1
          fi
          
          echo "post_id=$POST_ID" >> $GITHUB_OUTPUT
          echo "โ ุชู ุงููุดุฑ ุจูุฌุงุญ!"
          echo "๐ Post ID: $POST_ID"
        else
          echo "โ ูุดู ุงููุดุฑ!"
          echo "$BODY" | jq '.'
          exit 1
        fi
    
    - name: ุชุนุฏูู ุงูููุดูุฑ ุงูููุฌูุฏ
      if: steps.determine_action.outputs.action == 'update'
      env:
        FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
      run: |
        POST_ID="${{ steps.determine_action.outputs.existing_post_id }}"
        
        if [ -z "$POST_ID" ] || [ "$POST_ID" == "null" ]; then
          echo "โ ุฎุทุฃ: ูุง ููุฌุฏ Post ID ููุชุนุฏูู"
          exit 1
        fi
        
        echo "๐ ุฌุงุฑู ุชุนุฏูู ุงูููุดูุฑ: $POST_ID"
        
        MESSAGE=$(cat /tmp/post_content.txt | jq -sRr @uri)
        
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "https://graph.facebook.com/v21.0/$POST_ID" \
          -d "message=$MESSAGE" \
          -d "access_token=$FB_PAGE_TOKEN")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "HTTP Status: $HTTP_CODE"
        
        if echo "$BODY" | jq -e '.success == true' > /dev/null 2>&1; then
          UPDATE_COUNT=$(jq --arg today "${{ steps.determine_action.outputs.today }}" \
            '.posts[] | select(.date == $today) | .updates | length' \
            data/posts_log.json)
          
          echo "โ ุชู ุงูุชุนุฏูู ุจูุฌุงุญ!"
          echo "๐ข ุงูุชุนุฏูู ุฑูู: $((UPDATE_COUNT + 1))"
        else
          echo "โ ูุดู ุงูุชุนุฏูู!"
          echo "$BODY" | jq '.'
          exit 1
        fi
    
    - name: ุชุญุฏูุซ ุงูุณุฌู
      run: |
        TODAY="${{ steps.determine_action.outputs.today }}"
        ACTION="${{ steps.determine_action.outputs.action }}"
        POST_FILE="${{ steps.select_post.outputs.post_basename }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        CURRENT_TIME="${{ steps.determine_action.outputs.current_time }}"
        HAS_IMAGE="${{ steps.find_image.outputs.has_image }}"
        
        if [ "$ACTION" == "publish" ]; then
          POST_ID="${{ steps.publish_post.outputs.post_id }}"
          
          # ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ
          jq --arg date "$TODAY" \
             --arg post_id "$POST_ID" \
             --arg file "$POST_FILE" \
             --arg time "$TIMESTAMP" \
             --arg clock "$CURRENT_TIME" \
             --arg img "$HAS_IMAGE" \
             '.posts += [{
               "date": $date,
               "post_id": $post_id,
               "initial_file": $file,
               "published_at": $time,
               "published_time": $clock,
               "has_image": ($img == "true"),
               "updates": [{
                 "file": $file,
                 "timestamp": $time,
                 "time": $clock,
                 "action": "published",
                 "has_image": ($img == "true")
               }]
             }]' data/posts_log.json > data/posts_log.tmp
          
        else
          # ุชุญุฏูุซ ุณุฌู ููุฌูุฏ
          jq --arg date "$TODAY" \
             --arg file "$POST_FILE" \
             --arg time "$TIMESTAMP" \
             --arg clock "$CURRENT_TIME" \
             --arg img "$HAS_IMAGE" \
             '(.posts[] | select(.date == $date).updates) += [{
               "file": $file,
               "timestamp": $time,
               "time": $clock,
               "action": "updated",
               "has_image": ($img == "true")
             }]' data/posts_log.json > data/posts_log.tmp
        fi
        
        mv data/posts_log.tmp data/posts_log.json
        echo "โ ุชู ุชุญุฏูุซ ุงูุณุฌู"
    
    - name: ุญูุธ ุงูุชุบููุฑุงุช
      run: |
        git add data/posts_log.json
        
        if git diff --staged --quiet; then
          echo "โน๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช"
        else
          ACTION="${{ steps.determine_action.outputs.action }}"
          TIME="${{ steps.determine_action.outputs.current_time }}"
          
          if [ "$ACTION" == "publish" ]; then
            MSG="โจ ูุดุฑ ููุดูุฑ - $TIME UTC"
          else
            MSG="๐ ุชุนุฏูู ููุดูุฑ - $TIME UTC"
          fi
          
          git commit -m "$MSG"
          git push
          echo "โ ุชู ุงูุญูุธ"
        fi
    
    - name: ููุฎุต ุงูุนูููุฉ
      if: always()
      run: |
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ ููุฎุต ุงูุนูููุฉ"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""
        echo "๐ ุงูุชุงุฑูุฎ: ${{ steps.determine_action.outputs.today }}"
        echo "โฐ ุงูููุช: ${{ steps.determine_action.outputs.current_time }} UTC"
        echo "๐ฌ ุงูุฅุฌุฑุงุก: ${{ steps.determine_action.outputs.action }}"
        echo "๐ ุงูููู: ${{ steps.select_post.outputs.post_basename }}"
        echo "๐ธ ุตูุฑุฉ: ${{ steps.find_image.outputs.has_image }}"
        
        if [ "${{ steps.find_image.outputs.has_image }}" == "true" ]; then
          echo "๐ผ๏ธ  ุงูุตูุฑุฉ: $(basename ${{ steps.find_image.outputs.image_file }})"
        fi
        
        if [ "${{ steps.determine_action.outputs.action }}" == "publish" ]; then
          echo "๐ Post ID: ${{ steps.publish_post.outputs.post_id }}"
        else
          echo "๐ Post ID: ${{ steps.determine_action.outputs.existing_post_id }}"
        fi
        
        echo ""
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ ุชุญุฏูุซุงุช ุงูููู"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        
        TODAY="${{ steps.determine_action.outputs.today }}"
        jq -r --arg today "$TODAY" \
          '.posts[] | select(.date == $today) | .updates[] | 
          "โฐ \(.time) - \(.action) - ๐ \(.file)"' \
          data/posts_log.json 2>/dev/null || echo "ูุง ุชูุฌุฏ ุชุญุฏูุซุงุช"
        
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
